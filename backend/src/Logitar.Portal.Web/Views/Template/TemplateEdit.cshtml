@using Logitar.Portal.Core.Emails.Senders;
@using Logitar.Portal.Core.Emails.Senders.Models;
@using Logitar.Portal.Core.Emails.Templates.Models;
@using Logitar.Portal.Core.Users;
@using Logitar.Portal.Web.Models.Users;

@inject ISenderService _senderService;

@model TemplateModel
@{
  Layout = "_Layout";

  ViewBag.Title = Model?.DisplayName ?? Model?.Key ?? "Create template";

  SenderModel? sender = await _senderService.GetDefaultAsync(Model?.Realm?.Id.ToString());
  string? senderJson = sender == null ? null : ModelSerializer.Serialize(sender);
}

@functions {
  private UserSummary UserSummary
  {
    get
    {
      User? user = Context.GetUser();

      return new UserSummary
      {
        IsAuthenticated = user != null,
        Email = user?.Email,
        FullName = user?.FullName,
        Picture = user?.Picture,
        Username = user?.Username
      };
    }
  }
}

@if (Model == null)
{
  <template-edit realm="@(Context.Request.Query["realm"])"></template-edit>
}
else
{
  <template-edit json="@(ModelSerializer.Serialize(Model))" sender="@(senderJson)" status="@(Context.Request.Query["status"])" user="@(ModelSerializer.Serialize(UserSummary))"></template-edit>
}
